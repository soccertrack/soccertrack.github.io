<!DOCTYPE HTML>

<html>
	<head>
		<title></title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
		<script>
			function load() {
				let params = new URLSearchParams(window.location.search);
				let merchant = params.get("merchant");
				let year = params.get("year");
				let img = params.get("img");

				window.title = "TrackSpendr - " + merchant + " result";
				document.getElementById("img").src = "images/" + img;
				document.getElementById("spendingTitle").innerText = "Your " + merchant + " Spending for " + year;
				document.getElementById("generationTitle").innerText = "Report generated from analyzing your " + merchant + " spending via TrackSpendR technology.";
			}
		</script>

		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZSDE9NF2W7"></script>
		<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-ZSDE9NF2W7');
		</script>
	</head>
	<body class="left-sidebar is-preload" onload="load();">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header" style="background-color:black;">

					<!-- Logo -->
						<h1><a href="index.html" style="color:white;">TrackSpendR</a></h1>
				</section>

			<!-- Main -->
				<section id="main">
					<div class="container">
						<div class="row">
							<div class="col-4 col-12-medium">

								<!-- Sidebar -->
									<section class="box">
										<a href="#" class="image featured"><img id="img" alt="" /></a>
										<header>
											<h3>TrackSpendR Home</h3>
										</header>
										<p>Analyze other e-commerce spending.</p>
										<footer>
											<a href="index.html" class="button alt">&lt; Home</a>
										</footer>
									</section>

							</div>
							<div class="col-8 col-12-medium imp-medium">

								<!-- Content -->
									<article class="box post">
										<header>
											<h2 id="spendingTitle">Your Spending</h2>
											<p id="generationTitle">Report generated from analyzing your spending via TrackSpendR technology.

										</header>
										<footer>
											<a id="csvDownload" style="background-color: darkgreen;" class="button alt">Download Orders (Spreadsheet)</a>
										</footer>
										<hr>
										<h4>No. of orders: <span id="numOrders">0</span></h4>
										<h4>Total Purchases: <span id="totalAmt">$0.0</span></h4>
										<h4>Total Sales Tax Paid: <span id="salesTax">$0.00</span></h4>
										<hr>
										<div><canvas id="doughnut-chart" width="700" height="450"></canvas></div>
										<hr>
										<div><canvas id="bar-chart" width="700" height="450"></canvas></div>
										<table>
											<tr style="background-color: lightgray;">
												<td><b>Month</b></td>
												<td><b>Order Quantity</b></td>
												<td><b>Order Amount</b></td>
											</tr>
											<tr>
												<td>January</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>February</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>March</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>April</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>May</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>June</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>July</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>August</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>September</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>October</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>November</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
											<tr>
												<td>December</td>
												<td class="OrderQuantity">0</td>
												<td class="OrderAmount">$0</td>
											</tr>
										</table>
										
									</article>

							</div>
						</div>
					</div>
				</section>
		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

			<script>
				const dataSet = {
					type: 'doughnut',
					data: {
					labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
					datasets: [
						{
						label: "Spending ($)",
						backgroundColor: ["#000000", "#333333","#666666","#999999","#CCCCCC", "#00CC00", "#33DD33", "#77EE77", "#AAFFAA", "#0000CC", "#3333CC", "#6666CC"],
						data: []
						}
					]
					},
					options: {
						responsive: true,
						title: {
							display: true,
							text: "Spending $"
						}
					}
				};

				const dataSet2 = {
					type: 'bar',
					data: {
					labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
					datasets: [
						{
						label: "Quantity)",
						backgroundColor: ["#000000", "#333333","#666666","#999999","#CCCCCC", "#00CC00", "#33DD33", "#77EE77", "#AAFFAA", "#0000CC", "#3333CC", "#6666CC"],
						data: []
						}
					]
					},
					options: {
						legend: { display: false },
					title: {
						display: true,
						text: 'Order Quantity'
						}
					}
				};

				function updateResults(amt, units, salesTax) {

					var unitTotal = 0;
					var amountTotal = 0;

					dataSet.data.datasets[0].data = amt;
					dataSet2.data.datasets[0].data = units;

					new Chart(document.getElementById("doughnut-chart"), dataSet);
					new Chart(document.getElementById("bar-chart"), dataSet2);

					const quantities = document.getElementsByClassName("OrderQuantity"); 
					for(var i=0;i<quantities.length;++i){
						let num = dataSet2.data.datasets[0].data[i];
						quantities[i].innerText = num;
						unitTotal += num;
					}

					const amounts = document.getElementsByClassName("OrderAmount");
					for(var i=0;i<amounts.length;++i){
						let num = dataSet.data.datasets[0].data[i];
						amounts[i].innerText = dataSet.data.datasets[0].data[i].toFixed(2);
						amountTotal += num;
					}

					let salesTaxElement = document.getElementById("salesTax");
					salesTaxElement.innerText = "$" + salesTax;
					
					let numOrdersElement = document.getElementById("numOrders");
					numOrdersElement.innerText = unitTotal;
					
					let totalAmtElement = document.getElementById("totalAmt");
					totalAmtElement.innerText = "$" + amountTotal.toFixed(2);
				}

				function updateCSV(details) {
					var content = "data:text/csv;charset=utf-8,Date,OrderId,Type,SubTotal,SalesTax,OrderUrl\n";
					
					details.forEach(item => {
						let row = item.date.replace(',', ' ') + ",'" + item.order + "'," + item.type + "," + item.subTotalAmt + "," + item.taxTotalAmt + "," + item.orderUrl + "\n";
						content += row;
					});
					let link = document.getElementById("csvDownload");
					link.setAttribute("href", encodeURI(content));
					link.setAttribute("download", "data.csv");
				}

				document.addEventListener('resultEvent', function (e) {

					let data = e.detail;
					let summary = data[0];
					let details = data[1];
					updateResults(summary[0], summary[1], summary[2]);
					updateCSV(details);
				});
		</script>


	</body>
</html>